VISUALID = {
	AncientElf = "6439c71c-87f4-4c02-80c2-0f9537954f9d",
	FailedGheist = "6439c71c-87f4-4c02-80c2-0f9537954f9d",
	DemonKin = "d656291b-81f3-445e-84df-4e32cfc18d46",
	LivingBear = "b8ddbc75-415f-4894-afc2-2256e11b723d",
	Zombie = "ab01c22a-cce0-483b-84e6-2d331b6c2982"
}

EMPTY_VISUAL = "ROR_Empty"

VisualResources = {
	AncientElf = {},
	FailedGheist = {},
	LivingBear = {},
	Zombie = {},
	DemonKin = {
		ACCESSORY_Ghoul_Steaks_A = "094f7424-7fe3-471b-a040-1977ef0bc3e6",
		ACCESSORY_Ghoul_Steaks_B = "c303392c-4394-4161-a6a7-4ba34d1e620c",
		ACCESSORY_Ghoul_Sword_A = "3dd7fe41-532c-43f4-bde0-2145f9503ae2",
		CLOTH_Demon_Rags_Armor_A = "4611b7b5-3b12-4924-a1c7-ffd8a3e7a86d",
		CLOTH_TrollFez_Helmet_A = "be8d0ad9-8e7a-4cbe-87c0-acf21c5528c1",
		LEATHER_Assassin_Armor_A = "1d3df97d-fae2-49a9-8768-d16d984924c5",
		LEATHER_Assassin_Helmet_A = "6c37e206-d71d-43c7-a766-62ef92f8778f",
		LEATHER_Gheist_Armor_A = "37133caa-fa96-4c67-b45e-9aa010395e92",
		LEATHER_Gheist_Helmet_A = "6eae2a8c-b3be-4db9-b8cb-1d8889169c22",
		LEATHER_Lizard_Armor_A = "587b48ea-e759-4db1-b91a-866482bad5b0",
		LEATHER_Lizard_Helmet_A = "1e5d548e-2eb7-478f-bd8c-928292d9194a",
		LEATHER_Lizard_Helmet_B = "8daedaa4-abf1-4b3a-a9ad-851bce02b2df",
		LEATHER_Werewolf_Armor_A = "9dca6911-ea97-42ab-afd7-f8600a699e07",
		MAIL_AlanBird_Armor_B = "718f88c7-5d6d-4779-8aa6-198357f981a5",
		MAIL_Lizard_Chain_Armor_A = "8161e528-d331-410c-a1b7-434473090031",
		MAIL_Lizard_Chain_Helmet_A = "bf098573-4a47-4bdd-9e44-0786f3a6dcde",
		MAIL_Lizard_Chain_Helmet_B = "7d1d5445-f616-44e2-9040-a14c13dc681a",
		MAIL_Lizard_Scale_Armor_A = "a75b5807-efd1-41d6-a209-22565426bfff",
		MAIL_Lizard_Scale_Helmet_A = "77a735a1-5517-4628-bc25-44c853198e9a",
		PLATE_Ghoul_Armor_A = "cec3f907-77dc-491b-a5c7-55437458a7df",
		PLATE_Ghoul_Helmet_A = "f1863b0a-5251-4af4-9d43-19df14310755",
		PLATE_Lizard_Armor_A = "3d3f2158-808a-4280-9c90-b2940379b4ac",
		PLATE_Lizard_Armor_B = "03177b6c-f740-491c-b250-af91be623592",
		PLATE_Lizard_Helmet_A = "359772c0-4a54-4a62-88ba-4f6ed693d1d4",
		PLATE_SquirrelKnight_Helmet_A = "57a79b68-d9aa-4cdc-84cb-63f9f76c9465",
		PLATE_TerracottaGardian_Armor_A = "4dc4f621-6065-4485-932e-601e8eff1466",
		PLATE_TerracottaGardian_Armor_B = "8d65cc9c-f9c9-4d2a-89ce-51a562276898",
		PLATE_Utopian_Armor_A = "35c9a110-4ce5-4af5-8d48-0e08a70656dc",
		ROBE_AlanBird_Armor_A = "2531d962-7598-4a08-9225-306c6bbbb57b",
		ROBE_AlanBird_Armor_C = "dfd86d14-aefc-4cb9-ab36-db5918b72795",
		ROBE_AlanBird_Helmet_A = "9df3f10f-0f68-4ec7-a093-de8b8c383cff",
		ROBE_AlanBird_Helmet_B = "c3b3ff09-e798-49e4-9bd5-9b51123d0b9e",
		ROBE_BurningWitch_Armor_A = "e76f6120-5db7-4ee5-91d7-75076430ba85",
		ROBE_Demon_Armor_A = "c713c983-b50a-4983-936c-9ac0af3ae7d5",
		ROBE_Dreamer_Armor_A = "329ce923-2094-4c79-aba6-55b6bbd210b9",
		ROBE_Dreamer_Armor_B = "eb43da52-8e1c-479d-9596-8a1365301552",
		ROBE_Dreamer_Helmet_A = "daca2d2a-91f4-4bad-aa59-ad5d120a1f5b",
		ROBE_Dreamer_Helmet_B = "819dfe4f-7156-4157-b79a-7f1c648f2c65",
		ROBE_Ghoul_Armor_A = "43a59996-1329-4064-a3ce-f44a16074902",
		ROBE_Incarnate_Armor_A = "9b2c8deb-f250-4c59-94e2-091e67b803d6",
		ROBE_Incarnate_Helmet_A = "f910f884-3c87-4f99-838a-e436c3cb15f2",
		ROBE_Lizard_Armor_A = "d3daabe4-9ee5-4695-854e-84309f39a0e1",
		ROBE_Lizard_Helmet_A = "5a877528-b690-44d1-a88f-1c2dd9531c39",
	},
}

VisualData = {}

---@class VisualDataEntry
---@field Uniques {Stats:table<string,string>, Tags:table<string,string>}
---@field ArmorTypes table<ArmorType, table<ItemSlot, string>>
---@field RarityArmorTypes table<ArmorType, table<ItemRarity, table<integer, table<ItemSlot, string>>>>
---@field Weapons table<string,string>

Ext.Require("Client/Armor/AncientElf.lua")
Ext.Require("Client/Armor/DemonKin.lua")
Ext.Require("Client/Armor/FailedGheist.lua")
Ext.Require("Client/Armor/LivingBear.lua")
Ext.Require("Client/Armor/Zombie.lua")

---@param char EclCharacter
---@param item EclItem
---@param data OriginUniqueItemData
---@return string|nil
local function GetUniqueArmorType(char, item, data)
	if not data then
		return nil
	end
	local statArmorType = data.Stats[item.StatsId]
	if statArmorType then
		return statArmorType
	end
	for tag,armorType in pairs(data.Tags) do
		if GameHelpers.ItemHasTag(item, tag) then
			return armorType
		end
	end
	return nil
end

---@param character EclCharacter
---@param data VisualDataEntry
---@param armorType ArmorType
---@param slot ItemSlot
---@param rarity ItemRarity
---@return string|nil
local function GetVisualForArmorType(character, data, armorType, slot, rarity)
	local armorTypeData = data.ArmorTypes[armorType]
	if armorTypeData and armorTypeData[slot] then
		return armorTypeData[slot]
	end
	local rarityArmorTypeData = data.RarityArmorTypes[armorType]
	if rarityArmorTypeData then
		local rarityData = rarityArmorTypeData[rarity] or rarityArmorTypeData.All
		if rarityData then
			local level = character.Stats.Level
			local levelCap = GameHelpers.GetExtraData("LevelCap", 30)
			for i=1,#rarityData do
				local v = rarityData[i]
				if (v.Min == nil or level >= v.Min or v.Min <= 0) and (v.Max == nil or level <= v.Max or v.Max >= levelCap) then
					if v[slot] then
						return v[slot]
					end
				end
			end
		end
		if armorTypeData and armorTypeData[slot] then
			return armorTypeData[slot]
		end
	end
	return nil
end

Ext.Events.CreateEquipmentVisualsRequest:Subscribe(function (e)
	local character = e.Character or Client:GetCharacter() --[[@as EclCharacter]]
	if character then
		local characterVisual = character.CurrentTemplate.VisualTemplate
		local data = VisualData[characterVisual] --[[@as VisualDataEntry]]
		if data then
			local slot = e.Params.Slot
			local item = character:GetItemObjectBySlot(slot)
			if item then
				local template = GameHelpers.GetTemplate(item) --[[@as string]]
				local rarity = item.Stats.ItemTypeReal --[[@as ItemRarity]]
				local specialArmorType = GetUniqueArmorType(character, item, data.Uniques)
				if specialArmorType then
					local visual = GetVisualForArmorType(character, data, specialArmorType, slot, rarity)
					if visual then
						e.Params.VisualResourceID = visual
						return
					end
				end
				if item.Stats.ItemType == "Armor" then
					local armorType = item.Stats.StatsEntry.ArmorType
					local visual = GetVisualForArmorType(character, data, armorType, slot, rarity)
					if visual then
						e.Params.VisualResourceID = visual
						return
					end
				else
					local visual = data.Weapons[template] or data.Weapons[item.Stats.Name]
					if visual then
						e.Params.VisualResourceID = visual
						return
					end
				end
			end
		end
	end
end)